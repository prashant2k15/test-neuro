import{m as d,C as q}from"./entry.bcc9fae7.js";import{a as P,P as z,O as K}from"./PaymentServices.7cf2e745.js";import{A as X,a as R}from"./HLConst.dfc90e13.js";import{L as A,G as ee,I as $,w as H}from"./helpers.7602a90c.js";import{F as ie}from"./FunnelServices.57c717c2.js";import{f as B}from"./funnel_event_helper.35b1096b.js";import{k as Q,m as D,d as V,e as Z,h as G}from"./Attributions.d5135362.js";import{v as re,A as ae}from"./index.01cff31b.js";import{u as te}from"./index.cca9defc.js";const he={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},be=(e,r,t)=>{let o=[];return{updatedProducts:e.map(a=>{if(a._id===t._id){if(r>a.max)return a.qty=a.qty,o.push(`A maximum of ${a.max} units of ${a.name} only can be purchased`),a;if(r>a.price.availableQuantity&&a.price.trackInventory&&!a.price.allowOutOfStockPurchases)return a.qty=a.qty,o.push(`Only ${a.price.availableQuantity} units of ${a.name} are in stock`),a;a.qty=r}return a}),errorMessages:o}},Pe=e=>{var r,t,o;return((r=e==null?void 0:e.price)==null?void 0:r.availableQuantity)<=0&&((t=e==null?void 0:e.price)==null?void 0:t.trackInventory)&&!((o=e==null?void 0:e.price)!=null&&o.allowOutOfStockPurchases)},_e=(e,r)=>r.find(t=>t._id===e.id),ne=async({contactId:e,domain:r,pageUrl:t,locationId:o,productPreviewList:n,isCouponApplied:a,couponCode:i,couponSessionId:s,store:m,subType:c,traceId:_,reCaptchaToken:f,isEcommercePurchase:S,shippingRateId:y})=>{var v,I,l,E;try{const g=d("msgsndr_id").value,F=d("am_id").value,T=d("am_fingerprint").value,O=m.funnelName||"funnel";r||(r=window.location.hostname,t=window.location.pathname);const{funnelPageId:N,funnelId:p,stepId:C}=m,w={altId:o,altType:"location",shippingRateId:y,contactId:e,source:{type:m.pageType===P.FUNNEL?P.FUNNEL:P.WEBSITE,subType:c,id:p,name:O,meta:{stepId:C,pageId:N,domain:r,pageUrl:t,affiliateManager:{id:F,fingerprint:T}}},products:n.map(b=>({id:S?b.selectedPrice._id:b._id,qty:b.qty||b.quantity})),fingerprint:g,trackingId:A(),traceId:_};a&&(w.couponCode=i,w.couponSessionId=s),f&&(w.captchaToken=f);const h=await z.createOrder(w);if(!((v=h.order)==null?void 0:v._id))throw new Error("Something went wrong while creating order. Please try again later.");return h}catch(g){return console.error(g),{error:!0,message:(l=(I=g==null?void 0:g.response)==null?void 0:I._data)==null?void 0:l.message,status:(E=g==null?void 0:g.response)==null?void 0:E.status}}},se=async(e,r,t,o,n,a)=>{var x,L,M;const i=d("msgsndr_id").value,s=d("am_id").value,m=d("am_fingerprint").value,c=Z(e.locationId),_=G(e.locationId),f=V(),S=e.funnelName||"funnel";let{domain:y,page_url:v}=r.query;y||(y=window.location.hostname,v=window.location.pathname);const{funnelPageId:I,funnelId:l,stepId:E}=e,g={eventType:"optin",domainName:y,pageUrl:v,funnelId:l,pageId:I,stepId:E},{address:F,country:T,state:O,city:N,zipcode:p,fullName:C,phoneNumber:w,emailId:h,companyName:U}=t,b={addressLine1:F,country:T||o,state:O,city:N,zip:p};f.medium=ae.OrderForm,f.mediumId=g.stepId;const J={lead:!0,eventData:f,source:S,pageId:I,funnelId:l,sessionId:c,funnelEventData:g,sessionFingerprint:_||null},k={locationId:e.locationId,name:C,phone:w,email:(h==null?void 0:h.toLowerCase())||"",companyName:U,address:b,attribution:J,timezone:ee(),amId:String(s),amFingerprint:m,orderFormType:"one_step_form_submission",captchaToken:n};a.enableStickyContact&&(k.attribution.fingerprint=i,k.attribution.funnelEventData.fingerprint=i),a.enableForceCreate&&(k.attribution.forceCreate=!0),a.enableEmailValidation&&(k.attribution.session_d=Number(a.enableEmailValidation)||0);try{const u=await ie.createContact(k);if(!u)throw new Error("Something went wrong. Please try again later.");if(i!==u.fingerprint){e.fingerprint=i;const j=d("msgsndr_id",{path:"/",maxAge:31536e3});j.value=u.fingerprint}A();const Y=$(u);H("_ud",Y),q(()=>{B("track","SubmitApplication")});let W=u.sessionFingerprint;return f&&(Q({sessionId:u.sessionId||null,locationId:e.locationId}),W&&D(e.locationId,W)),u}catch(u){return console.error(u),{error:!0,message:(L=(x=u==null?void 0:u.response)==null?void 0:x._data)==null?void 0:L.message,status:(M=u==null?void 0:u.response)==null?void 0:M.status}}},Se=async(e,r,t,o,n,a,i,s,m,c,_,f,S,y,v)=>{var I;if((!i||!i.id)&&(i=await se(e,r,t,o,n,a),n=void 0),i!=null&&i.error){let l={};return(i==null?void 0:i.status)===429?(l={error:!0,processingPayment:!1,showRecaptcha:!0},l):(l={error:!0,processingPayment:!1,cardErrorMsg:i.message||"We're sorry, but something went wrong. Please try again"},l)}if((i.id&&!s||!((I=s==null?void 0:s.order)!=null&&I._id))&&(s=await ne({contactId:i==null?void 0:i.id,domain:e.domain,pageUrl:e.pageUrl,locationId:e.locationId,productPreviewList:c,isCouponApplied:m,couponCode:f,couponSessionId:_,store:e,subType:y,traceId:i==null?void 0:i.traceId,reCaptchaToken:n,isEcommercePurchase:S,shippingRateId:v}),n=void 0),s!=null&&s.error){let l={};return s.status===429?(l={error:!0,processingPayment:!1,showRecaptcha:!0,contactResponse:i},l):(l={error:!0,processingPayment:!1,contactResponse:i,cardErrorMsg:s.message||"We're sorry, but something went wrong. Please try again"},l)}return(s==null?void 0:s.success)===!1?{error:!0,cardErrorMsg:s==null?void 0:s.message,processingPayment:!1}:{contactResponse:i,orderResponse:s,reCaptchaToken:n}},oe=(e,r,t,o)=>{var a;if(A()!=t.verifiedTrackingId){const i=d("tr",{path:"/",maxAge:900});i.value=t.verifiedTrackingId}if(o!==K.TWO_STEP_ORDER_FORM){if(e.fingerprint!==r){const s=d("msgsndr_id",{path:"/",maxAge:31536e3});s.value=e.fingerprint}const i=$(e);H("_ud",i)}if((a=e==null?void 0:e.attribution_source)!=null&&a.fbEventId){let i=e.attribution_source.fbEventId;q(()=>{B("track","OrderFormPurchase",i)})}else console.warn("Facebook event Id missing from attribution!")},ke=async(e,r,t,o,n)=>{let a=!1,i="";if(r.message&&!r.success)throw new Error(r.message);t===X&&(r!=null&&r.pendingConfirmation)&&(a=!0,i="Order placed successfully! However your transaction is pending for review. Please contact the business owner");const s=d("msgsndr_id").value;await oe(e,s,r,n);const m=d("provider");m.value=t===R?"pp":"cc",await le({sessionId:e.sessionId,sessionFingerprint:r.sessionFingerprint},o);const c=sessionStorage.getItem("redirect");if(ue(o),c){sessionStorage.removeItem("redirect"),window.location.href=c;return}return{paymentResponseData:r,authorizeOrderPendingConfirmation:a,authorizeOrderAlertMsg:i}},le=(e,r)=>{e&&e.sessionId&&(Q({sessionId:e.sessionId||null,locationId:r}),e.sessionFingerprint&&D(r,e.sessionFingerprint))},Ee=(e,r,t)=>{var o;return{facilitatorAccessToken:e.facilitatorAccessToken,orderId:(o=r==null?void 0:r.order)==null?void 0:o._id,paypalOrderId:e.orderID,altId:t,altType:"location",attribution:{eventData:V(),sessionId:Z(t),sessionFingerprint:G(t)}}},Fe=e=>{var t;(!(e.keyCode>=48&&e.keyCode<=57||e.keyCode>=96&&e.keyCode<=105)||!/^\d{0,2}$/.test((t=e.target)==null?void 0:t.value))&&e.keyCode!==8&&e.preventDefault()},ue=e=>{const r=re();return sessionStorage.setItem(`couponSessionId_${e}`,r),r},Te=async(e,r,t="")=>{var o;try{const n=te(),a={altId:n.value.locationId,altType:"location",couponCode:t,source:{type:n.value.pageType===P.FUNNEL?P.FUNNEL:P.WEBSITE,subType:r,id:n.value.funnelId,name:n.value.funnelName,meta:{stepId:n.value.stepId,pageId:n.value.funnelPageId,domain:n.value.domain,pageUrl:n.value.pageUrl,affiliateManager:{id:d("am_id").value,fingerprint:d("msgsndr_id").value}}},products:e},i=await z.getTaxInformation(a);if(i.error)throw new Error("Something went wrong while fetching order total. Please try again later");return{total:i.total,subtotal:i.subtotal,taxSummary:i.summary,subtotalWithDiscount:i.subtotalWithDiscount}}catch(n){return console.error(n),{error:!0,message:"Something went wrong while fetching order total. Please try again later",status:(o=n==null?void 0:n.response)==null?void 0:o.status}}};export{_e as a,Ee as b,ne as c,be as d,Se as e,Te as f,ue as g,ke as h,Pe as i,Fe as k,he as s};
